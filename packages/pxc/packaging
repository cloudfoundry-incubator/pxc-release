#!/bin/bash

set -euo pipefail

function build_libaio {
  tar -zxf libaio_0.3.110.orig.tar.gz
  cd libaio-0.3.110
  make install
  cd -
}

function build_pxc8 {
  local boost_dir build_dir

  tar -xf Percona-XtraDB-Cluster-*.tar.gz
  tar -xf boost_*.tar.bz2

  boost_dir=$(cd boost_*/ && pwd)
  build_dir=$(mktemp --directory --tmpdir=. build.XXXXXXXXXX)

  cd "${build_dir}"
    cmake ../Percona-XtraDB-Cluster-*/ \
      -DBUILD_CONFIG=mysql_release \
      -DCMAKE_BUILD_TYPE=RelWithDebinfo \
      -DCMAKE_INSTALL_PREFIX="${BOSH_INSTALL_TARGET}" \
      -DENABLED_LOCAL_INFILE=off \
      -DINSTALL_MYSQLTESTDIR= \
      -DINSTALL_SBINDIR="${BOSH_INSTALL_TARGET}/sbin" \
      -DINSTALL_SECURE_FILE_PRIVDIR=NULL \
      -DINSTALL_STATIC_LIBRARIES=off \
      -DMYSQL_UNIX_ADDR=/var/vcap/sys/run/pxc-mysql/mysql.sock \
      -DMYSQLX_UNIX_ADDR=/var/vcap/sys/run/pxc-mysql/xmysqlx.sock \
      -DMYSQL_DATADIR=/var/vcap/store/pxc-mysql \
      -DSYSCONFDIR=/var/vcap/jobs/pxc-mysql/config \
      -DWITH_ROCKSDB=off \
      -DWITH_TOKUDB=off \
      -DWITH_BOOST="${boost_dir}" \
      -DWITH_ROUTER=off

    make --jobs "$(nproc)"
    make --jobs "$(nproc)" install
  cd -
}

function main {
  build_libaio
  build_pxc8
}

main
