#!/bin/bash

set -o errexit -o pipefail -o errtrace

build_scons() {
  (
    source /var/vcap/packages/python-2.7/bosh/compile.env
    tar -xf scons/scons-*.tar.gz
    cd scons-*/
    python setup.py install --prefix=/usr
  )
}

build_libboost() {
  (
    tar -xf boost_*.tar.bz2
    cd boost_*/
    ./bootstrap.sh --with-libraries=program_options,system --prefix=/usr
    ./b2 -j "$(nproc)" install
  )
}

build_libcheck() {
  (
    tar -xf check/check-*.tar.gz
    cd check-*/
    ./configure --prefix=/usr
    make -j "$(nproc)"
    make -j "$(nproc)" install
  )
}

build_libgalera() {
  (
    source /var/vcap/packages/python-2.7/bosh/compile.env
    tar -xf Percona-XtraDB-Cluster-*.tar.gz
    cd Percona-XtraDB-Cluster-*/percona-xtradb-cluster-galera
    HOME="$PWD" \
      scons psi=1 "revno=$(<GALERA-REVISION)" tests=0 libgalera_smm.so
    install --mode=0644 \
      -D libgalera_smm.so \
      "${BOSH_INSTALL_TARGET}/lib/libgalera_smm.so"
  )
}

main() {
  build_scons
  build_libcheck
  build_libboost
  build_libgalera
}

main
