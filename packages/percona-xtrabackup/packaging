#!/bin/bash

set -euo pipefail

build_libaio() {
  tar -zxf libaio_0.3.110.orig.tar.gz
  cd libaio-0.3.110
    make install
  cd -
}

build_libev() {
  ## libev (percona-xtrabackup -> xbcloud dependency)
  tar -xf libev-*.tar.gz
  cd libev-*/
    ./configure --prefix="${BOSH_INSTALL_TARGET}" --disable-static
    make -j "$(nproc)"
    make -j "$(nproc)" install
  cd -
}

build_percona_xtrabackup() {
  local boost_dir build_dir

  tar -xf percona-xtrabackup-*.tar.gz
  tar -xf boost_1_*.tar.bz2

  boost_dir=$(cd boost_1_*/ && pwd)
  build_dir=$(mktemp --directory --tmpdir=. build.XXXXXXXXXX)

  cd "${build_dir}"
    LDFLAGS="-Wl,-rpath,${BOSH_INSTALL_TARGET}/lib" \
    cmake ../percona-xtrabackup-*/ \
      -DBUILD_CONFIG=xtrabackup_release \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_INSTALL_PREFIX="${BOSH_INSTALL_TARGET}" \
      -DINSTALL_MYSQLTESTDIR= \
      -DINSTALL_STATIC_LIBRARIES=off \
      -DMYSQL_UNIX_ADDR=/var/vcap/sys/run/pxc-mysql/mysql.sock \
      -DMYSQL_DATADIR=/var/vcap/store/pxc-mysql \
      -DSYSCONFDIR=/var/vcap/jobs/pxc-mysql/config \
      -DWITH_BOOST="${boost_dir}" \
      -DWITH_VERSION_CHECK=OFF

    make --jobs "$(nproc)"
    make --jobs "$(nproc)" install
  cd -
}

function main() {
    build_libaio
    build_libev
    build_percona_xtrabackup
}

main
